name: autotag

on:
  push:
    branches:
      - main

jobs:
  tag:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 2
    # Check if the _last_ commit bumped the version
    - name: Check for version bump
      id: check
      run: |
        poetry_version() { awk '/^\s*$/{f=0};f{if ($1=="version") {gsub(/"/, "", $3); print($3)}};/\[tool\.poetry\]/{f=1}'; }
        echo "::set-output name=previous::$(git show HEAD^:pyproject.toml | poetry_version)"
        echo "::set-output name=current::$(git show HEAD:pyproject.toml | poetry_version)"
    - uses: actions-ecosystem/action-push-tag@v1
      if: ${{ steps.check.outputs.current != steps.check.outputs.previous }}
      with:
        tag: v${{steps.check.outputs.current}}
